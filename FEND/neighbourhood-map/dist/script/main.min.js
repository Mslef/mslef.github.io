function openInfoWindow(a){title.innerHTML=a.getTitle(),htmlContent.innerHTML="<h5 id='nyt'>New York Times articles: <button id='nyt-button' onclick='showNYT()'>Show</button></h5>",pin.set("position",a.getPosition()),infowindow.open(map,a)}var panorama,marker,infowindow=new google.maps.InfoWindow,geocoder=new google.maps.Geocoder,sv=new google.maps.StreetViewService,bounds=new google.maps.LatLngBounds,content=document.createElement("div"),title=document.createElement("div");content.appendChild(title);var streetview=document.createElement("div");streetview.style.width="250px",streetview.style.height="250px",content.appendChild(streetview);var htmlContent=document.createElement("div");content.appendChild(htmlContent);var infowindow=new google.maps.InfoWindow({content:content}),checkIfAdded=function(a,b){for(var c=b.length,d=a.title,e=0;c>e;e++)if(b[e].address===d)return b[e];return""},createMarker=function(a,b){return marker&&marker.setMap(null),marker=new google.maps.Marker({position:a,map:map,title:b,animation:google.maps.Animation.BOUNCE}),google.maps.event.addListener(marker,"click",function(){var a=checkIfAdded(marker,viewModel.addressList());""!==a?a.update():alert("Marker not found, make sure to save it to be able to click it!")}),marker},showPano=function(){panorama.setPano(data.location.pano),panorama.setPov({heading:270,pitch:0,zoom:1}),panorama.setVisible(!0)},processSVData=function(a,b){b==google.maps.StreetViewStatus.OK?panorama&&panorama.setPano&&(showPano(),google.maps.event.addListener(marker,"click",function(){var b=a.location.pano;panorama.setPano(b),showPano()})):(title.innerHTML=marker.getTitle()+"<br>Street View data not found for this location",htmlContent.innerHTML="<h5 id='nyt'>New York Times articles: <button id='nyt-button' onclick='showNYT()'>Show</button></h5>",panorama.setVisible(!1))},pin=new google.maps.MVCObject;google.maps.event.addListenerOnce(infowindow,"domready",function(){panorama=new google.maps.StreetViewPanorama(streetview,{navigationControl:!1,enableCloseButton:!1,addressControl:!1,linksControl:!1,visible:!0}),panorama.bindTo("position",pin)});var showNYT=function(){"Show"===$("#nyt-button").text()?($("#nyt-button").html("Hide"),0===$("#nyt #nytimes-articles").length?$("#nyt").append($("#nytimes-articles").clone()):$("#nyt #nytimes-articles").css("display","block")):($("#nyt-button").html("Show"),$("#nyt #nytimes-articles").css("display","none"))},findNYTLinks=function(a){$.getJSON(a,function(a){viewModel.nytArticleList([]),$("#nytimes-articles").html("");var b=a.response.docs.length;if(0===b)return void $("#nytimes-articles").html("No New York Times articles about this location, sorry!");for(var c=Math.min(b,5),d=0;c>d;d++){var e={};e.URL=a.response.docs[d].web_url,e.mainHeadline=a.response.docs[d].headline.main,e.snippet=a.response.docs[d].snippet,viewModel.nytArticleList.push(e)}}).error(function(){$("#nytimes-articles").html("Error loading New York Times articles, sorry!")})},AddressEntry=function(a,b){this.marker=a,this.city=b,this.address=a.getTitle(),this.loc=a.internalPosition,this.save=function(){return-1!==$.inArray(this,viewModel.addressList())?(viewModel.showWarning(!0),void setTimeout(function(){viewModel.showWarning(!1)},500)):void viewModel.addressList.unshift(this)},this.remove=function(){viewModel.addressList.remove(this)},this.update=function(){var b;map.setCenter(this.marker.internalPosition),viewModel.greeting("So, you want to live at "+this.address+"?"),a.setAnimation(google.maps.Animation.BOUNCE),window.setTimeout(function(){a.setAnimation(null)},2e3);var c="http://api.nytimes.com/svc/search/v2/articlesearch.json?q="+this.address+"&=sort=newest&api-key=773fe7f4f46bee0b96f79fa100da469a:11:71760315";findNYTLinks(c),infowindow.close(),openInfoWindow(a);for(var d=0;d<viewModel.addressList().length;d++)b=viewModel.addressList()[d].marker,b.setMap(map)}};ko.bindingHandlers.onEnter={init:function(a,b,c,d){ko.utils.registerEventHandler(a,"keydown",function(b){13===b.keyCode&&$(a).blur()})}};var viewModel={address:ko.observable(""),searchHistory:ko.observableArray(),searchValue:ko.observable(""),markers:ko.observableArray(),greeting:ko.observable("Where would you want to live?"),nytArticleList:ko.observableArray(),addressList:ko.observableArray(),showWarning:ko.observable(!1)};viewModel.stopEdit=function(){this.edit(!1)},viewModel.visibleAddress=ko.computed(function(){var a=[];if(maxLength=viewModel.addressList().length,""===viewModel.searchValue())return viewModel.addressList();for(var b=0;b<maxLength;b++){var c=viewModel.searchValue().toLowerCase(),d=viewModel.addressList()[b].address.toLowerCase();-1!==d.search(c)&&a.push(viewModel.addressList()[b])}return 0===a.length?(alert("Value not found!"),viewModel.searchValue(""),viewModel.addressList()):a}),viewModel.clearHistory=function(){viewModel.searchHistory([])},viewModel.findInfo=function(){geocoder.geocode({address:viewModel.address()},function(a,b){if(b==google.maps.GeocoderStatus.OK){var c=a[0].geometry.location,d=a[0].formatted_address,e=new AddressEntry(createMarker(c,d));-1===$.inArray(e,viewModel.searchHistory())&&viewModel.searchHistory.remove(e),viewModel.searchHistory.unshift(e),e.update()}else alert("Geocode was not successful for the following reason: "+b)})},ko.applyBindings(viewModel);